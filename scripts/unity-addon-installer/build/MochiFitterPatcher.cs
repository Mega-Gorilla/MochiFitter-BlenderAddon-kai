// ============================================
// MochiFitter-Kai Patcher DLL
// Auto-generated by generate_patcher.py
// Version: 1.0.0
// ============================================
//
// このDLLはsmoothing_processor.pyに最適化パッチを適用します。
//
// 使用方法:
//   MochiFitterPatcher.ApplyPatches(filePath);   // パッチ適用
//   MochiFitterPatcher.RemovePatches(filePath);  // パッチ削除
//   MochiFitterPatcher.IsPatched(filePath);      // 適用状態確認
// ============================================

using System;
using System.IO;
using System.Text;
using System.Collections.Generic;
using System.Text.RegularExpressions;

namespace MochiFitterKai
{
    /// <summary>
    /// パッチエントリ定義
    /// </summary>
    public class PatchEntry
    {
        public string PatchId { get; set; }
        public string Description { get; set; }
        public string OriginalCode { get; set; }
        public string OptimizedCode { get; set; }
        public int LineHint { get; set; }
    }

    /// <summary>
    /// パッチ適用結果
    /// </summary>
    public class PatchResult
    {
        public bool Success { get; set; }
        public int PatchesApplied { get; set; }
        public List<string> Messages { get; set; }
        public string Error { get; set; }

        public PatchResult()
        {
            Messages = new List<string>();
        }
    }

    /// <summary>
    /// smoothing_processor.py 最適化パッチャー
    /// </summary>
    public static class MochiFitterPatcher
    {
        /// <summary>
        /// パッチャーバージョン
        /// </summary>
        public const string Version = "1.0.0";

        /// <summary>
        /// 最適化マーカー（ファイルヘッダー）
        /// </summary>
        private const string OptimizationMarker = "# MochiFitter-Kai Optimized";

        /// <summary>
        /// パッチ定義リスト
        /// </summary>
        private static readonly PatchEntry[] Patches = new PatchEntry[]
        {
            new PatchEntry {
                PatchId = "blend_weights_vectorize_1",
                Description = "ウェイト合成ループのベクトル化 (1箇所目, line 402-406)",
                OriginalCode = "                            final_weights = np.zeros(len(vertex_coords), dtype=np.float32)\n                            \n                            for i in range(len(vertex_coords)):\n                                blend_factor = mask_weights[i]\n                                final_weights[i] = original_weights[i] * (1.0 - blend_factor) + smoothed_weights[i] * blend_factor",
                OptimizedCode = "                            # MochiFitter-Kai Optimized: NumPy vectorized blending (2544x faster)\n                            final_weights = original_weights * (1.0 - mask_weights) + smoothed_weights * mask_weights",
                LineHint = 402
            },
            new PatchEntry {
                PatchId = "blend_weights_vectorize_2",
                Description = "ウェイト合成ループのベクトル化 (2箇所目, line 477-480)",
                OriginalCode = "                        final_weights = np.zeros(len(vertex_coords), dtype=np.float32)\n                        for i in range(len(vertex_coords)):\n                            blend_factor = mask_weights[i]\n                            final_weights[i] = original_weights[i] * (1.0 - blend_factor) + smoothed_weights[i] * blend_factor",
                OptimizedCode = "                        # MochiFitter-Kai Optimized: NumPy vectorized blending (2544x faster)\n                        final_weights = original_weights * (1.0 - mask_weights) + smoothed_weights * mask_weights",
                LineHint = 477
            }
        };

        /// <summary>
        /// ファイルがパッチ適用済みかどうかを確認
        /// </summary>
        /// <param name="filePath">smoothing_processor.py のパス</param>
        /// <returns>パッチ適用済みの場合 true</returns>
        public static bool IsPatched(string filePath)
        {
            if (!File.Exists(filePath))
                return false;

            try
            {
                string content = File.ReadAllText(filePath, Encoding.UTF8);
                return content.Contains(OptimizationMarker);
            }
            catch
            {
                return false;
            }
        }

        /// <summary>
        /// パッチを適用
        /// </summary>
        /// <param name="filePath">smoothing_processor.py のパス</param>
        /// <returns>適用結果</returns>
        public static PatchResult ApplyPatches(string filePath)
        {
            var result = new PatchResult();

            if (!File.Exists(filePath))
            {
                result.Success = false;
                result.Error = "ファイルが見つかりません: " + filePath;
                return result;
            }

            try
            {
                string content = File.ReadAllText(filePath, Encoding.UTF8);

                // 改行コードを正規化（CRLF → LF）
                // Windows環境でFile.ReadAllTextがCRLFに変換する場合があるため
                content = content.Replace("\r\n", "\n").Replace("\r", "\n");

                // 既にパッチ適用済みの場合
                if (content.Contains(OptimizationMarker))
                {
                    result.Success = true;
                    result.Messages.Add("既にパッチ適用済みです");
                    return result;
                }

                // バックアップを作成
                string backupPath = filePath + ".bak";
                File.Copy(filePath, backupPath, true);
                result.Messages.Add("バックアップを作成: " + backupPath);

                // パッチを適用
                string modifiedContent = content;
                int appliedCount = 0;

                foreach (var patch in Patches)
                {
                    if (modifiedContent.Contains(patch.OriginalCode))
                    {
                        modifiedContent = modifiedContent.Replace(
                            patch.OriginalCode,
                            patch.OptimizedCode
                        );
                        result.Messages.Add("パッチ適用: " + patch.Description);
                        appliedCount++;
                    }
                    else
                    {
                        result.Messages.Add("パッチスキップ（コード不一致）: " + patch.Description);
                    }
                }

                // ヘッダーマーカーを追加
                if (appliedCount > 0)
                {
                    string header = "# ============================================" + Environment.NewLine +
                        "# MochiFitter-Kai Optimized" + Environment.NewLine +
                        "# Version: " + Version + Environment.NewLine +
                        "# Patches Applied: " + appliedCount.ToString() + Environment.NewLine +
                        "# DO NOT REMOVE THIS HEADER" + Environment.NewLine +
                        "# ============================================" + Environment.NewLine;
                    modifiedContent = header + modifiedContent;
                }

                // ファイルを書き込み
                File.WriteAllText(filePath, modifiedContent, Encoding.UTF8);

                result.Success = appliedCount > 0;
                result.PatchesApplied = appliedCount;

                if (appliedCount == 0)
                {
                    result.Error = "適用可能なパッチがありませんでした（コードが異なる可能性があります）";
                }
            }
            catch (Exception ex)
            {
                result.Success = false;
                result.Error = "パッチ適用中にエラー: " + ex.Message;
            }

            return result;
        }

        /// <summary>
        /// パッチを削除（バックアップから復元）
        /// </summary>
        /// <param name="filePath">smoothing_processor.py のパス</param>
        /// <returns>削除結果</returns>
        public static PatchResult RemovePatches(string filePath)
        {
            var result = new PatchResult();

            string backupPath = filePath + ".bak";

            if (!File.Exists(backupPath))
            {
                result.Success = false;
                result.Error = "バックアップファイルが見つかりません: " + backupPath;
                return result;
            }

            try
            {
                // バックアップから復元
                File.Copy(backupPath, filePath, true);
                result.Success = true;
                result.Messages.Add("バックアップから復元しました");
            }
            catch (Exception ex)
            {
                result.Success = false;
                result.Error = "復元中にエラー: " + ex.Message;
            }

            return result;
        }

        /// <summary>
        /// パッチ情報を取得
        /// </summary>
        /// <returns>パッチ定義のリスト</returns>
        public static PatchEntry[] GetPatchDefinitions()
        {
            return Patches;
        }
    }
}
