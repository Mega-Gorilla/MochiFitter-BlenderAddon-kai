# MochiFitter データフロー

## 全体フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        MochiFitter 全体データフロー                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              Phase 1: 準備                                  │
│                           (Blender アドオン)                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
    ┌───────────────────────────────┼───────────────────────────────┐
    │                               │                               │
    ▼                               ▼                               ▼
┌─────────┐                   ┌─────────┐                     ┌─────────┐
│ Avatar A │                   │ Avatar B │                     │ Mesh    │
│ (Source) │                   │ (Target) │                     │ Source  │
└────┬────┘                   └────┬────┘                     └────┬────┘
     │                              │                               │
     │ Save Pose                    │ Save Pose                     │ Generate
     │                              │                               │ Field
     ▼                              ▼                               ▼
┌─────────────┐               ┌─────────────┐               ┌─────────────┐
│pose_basis_  │               │pose_basis_  │               │deformation_ │
│A.json       │               │B.json       │               │A_to_B.npz   │
└──────┬──────┘               └──────┬──────┘               └─────────────┘
       │                              │
       └──────────────┬───────────────┘
                      │
                      ▼
               ┌─────────────┐
               │posediff_    │
               │A_to_B.json  │
               └─────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              Phase 2: 設定                                  │
│                            (Unity アドオン)                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Unity アドオン UI     │
                        │ - アバター選択        │
                        │ - データファイル選択  │
                        │ - ブレンドシェイプ設定│
                        └───────────┬───────────┘
                                    │
                                    ▼
                             ┌─────────────┐
                             │config_      │
                             │A2B.json     │
                             └─────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            Phase 3: リターゲット                             │
│                      (Unity → Blender subprocess)                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
              ┌─────────────────────┼─────────────────────┐
              │                     │                     │
              ▼                     ▼                     ▼
       ┌─────────────┐       ┌─────────────┐       ┌─────────────┐
       │ 衣装 FBX    │       │ ベース FBX  │       │ config.json │
       │ (入力)      │       │ (ターゲット)│       │ + データ    │
       └──────┬──────┘       └──────┬──────┘       └──────┬──────┘
              │                     │                     │
              └─────────────────────┼─────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ retarget_script       │
                        │ (Blender バックグラウンド)│
                        └───────────┬───────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
             ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
             │ output.fbx  │ │ output.blend│ │ (エラー時)  │
             │ リターゲット│ │ デバッグ用  │ │ *_error.blend│
             │ 済みメッシュ│ │             │ │             │
             └─────────────┘ └─────────────┘ └─────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            Phase 4: 完了                                    │
│                            (Unity アドオン)                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Unity Prefab 生成     │
                        │ リターゲット済み衣装  │
                        └───────────────────────┘
```

## ファイル別データフロー

### 1. ポーズデータ生成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ポーズデータ生成フロー                               │
└─────────────────────────────────────────────────────────────────────────────┘

[Blender]
    │
    ├── Avatar A (Armature)
    │       │
    │       │ save_armature_pose()
    │       │
    │       ▼
    │   pose_basis_A.json
    │       │
    │       │   ボーンごとに:
    │       │   - location (移動量)
    │       │   - rotation (回転・度)
    │       │   - scale (スケール)
    │       │   - head_world (ヘッド位置)
    │       │   - head_world_transformed (変形後位置)
    │       │
    │       └───────────┐
    │                   │
    ├── Avatar B (Armature)
    │       │           │
    │       │           │
    │       ▼           │
    │   pose_basis_B.json
    │       │           │
    │       └───────────┤
    │                   │
    │                   ▼
    │           ┌───────────────┐
    │           │ 差分計算      │
    │           │ delta_matrix  │
    │           │ = A^(-1) @ B  │
    │           └───────┬───────┘
    │                   │
    │                   ▼
    │           posediff_A_to_B.json
    │               │
    │               │   ボーンごとに:
    │               │   - delta_matrix (4x4 変換行列)
    │               │   - location, rotation, scale (参考値)
    │               │   - head_world, head_world_transformed
    │               │
    └───────────────┘
```

### 2. 変形フィールド生成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        変形フィールド生成フロー                              │
└─────────────────────────────────────────────────────────────────────────────┘

[Blender]
    │
    ├── Source Mesh (Basis)
    │       │
    │       │   制御点抽出
    │       │   (頂点座標 → ワールド座標)
    │       │
    │       ▼
    │   control_points_before[]
    │       │
    │       │
    ├── Source Mesh (ShapeKey/Deformed)
    │       │
    │       │   制御点抽出
    │       │   (変形後座標 → ワールド座標)
    │       │
    │       ▼
    │   control_points_after[]
    │       │
    │       └───────────────────────┐
    │                               │
    │                               ▼
    │                       ┌───────────────┐
    │                       │ RBF 補間計算  │
    │                       │ (Multi-Quadratic│
    │                       │  Biharmonic)  │
    │                       └───────┬───────┘
    │                               │
    │                               ▼
    │                       ┌───────────────┐
    │                       │ フィールド生成│
    │                       │ - グリッド点  │
    │                       │ - 変位ベクトル│
    │                       └───────┬───────┘
    │                               │
    │                               ▼
    │                       deformation_*.npz
    │                           │
    │                           │   含まれるデータ:
    │                           │   - all_field_points (座標)
    │                           │   - all_delta_positions (変位)
    │                           │   - num_steps (ステップ数)
    │                           │   - world_matrix (単位行列)
    │                           │   - rbf_epsilon (RBFパラメータ)
    │                           │
    └───────────────────────────┘
```

### 3. リターゲット処理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         リターゲット処理フロー                               │
└─────────────────────────────────────────────────────────────────────────────┘

[retarget_script]
    │
    │   入力:
    │   ├── 衣装 FBX (--input)
    │   ├── ベース FBX (--base-fbx)
    │   ├── config.json (--config)
    │   └── init_pose.json (--init-pose)
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 1: FBX インポート                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│ - ベースアバター FBX 読み込み                                                │
│ - 衣装 FBX 読み込み                                                         │
│ - avatar_data.json からボーン階層取得                                       │
└──────────────────────────────────────────────────────────────────────────┬──┘
                                                                           │
                                                                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 2: ポーズ適用                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ add_pose_from_json():                                                       │
│ - posediff.json から delta_matrix 読み込み                                  │
│ - 各ボーンに delta_matrix を適用                                            │
│ - combined_matrix = delta_matrix @ current_world_matrix                     │
└──────────────────────────────────────────────────────────────────────────┬──┘
                                                                           │
                                                                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 3: 変形フィールド適用                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ apply_symmetric_field_delta():                                              │
│ - deformation.npz からフィールドデータ読み込み                              │
│ - KDTree で最近傍点検索                                                     │
│ - RBF 補間で各頂点の変位を計算                                              │
│ - マルチステップで段階的に変形                                              │
└──────────────────────────────────────────────────────────────────────────┬──┘
                                                                           │
                                                                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 4: ウェイト転送                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ process_weight_transfer():                                                  │
│ - Humanoid ボーンのウェイトをベースから転送                                 │
│ - 補助ボーンのウェイト処理                                                  │
│ - ウェイトの正規化                                                          │
└──────────────────────────────────────────────────────────────────────────┬──┘
                                                                           │
                                                                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 5: ボーン置換                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ replace_humanoid_bones():                                                   │
│ - 衣装のボーンをターゲットのボーンに置換                                    │
│ - ボーン親子関係の更新                                                      │
└──────────────────────────────────────────────────────────────────────────┬──┘
                                                                           │
                                                                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 6: FBX エクスポート                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ export_fbx():                                                               │
│ - axis_forward='-Z', axis_up='Y' で座標変換                                 │
│ - リターゲット済みメッシュを出力                                            │
│ - .blend ファイルも保存（デバッグ用）                                       │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    │   出力:
    │   ├── output.fbx (リターゲット済みメッシュ)
    │   └── output.blend (デバッグ用シーン)
    │
    ▼
[Unity]
    │
    │   FBX インポート
    │   Prefab 生成
    │
    ▼
```

## データ依存関係

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            データ依存関係図                                  │
└─────────────────────────────────────────────────────────────────────────────┘

avatar_data_source.json ─────────────┐
                                     │
avatar_data_target.json ─────────────┼──▶ config_*.json
                                     │         │
pose_basis_source.json ──┐           │         │
                         ├──▶ posediff_*.json ─┤
pose_basis_target.json ──┘                     │
                                               │
source_mesh + target_shapekey ──▶ deformation_*.npz
                                               │
                                               ▼
                                    retarget_script
                                               │
                                               ▼
                                        output.fbx
```

## ファイル保存場所

### Blender アドオン出力

```
{任意のディレクトリ}/
├── avatar_data_{avatar_name}.json
├── pose_basis_{avatar_name}.json
├── posediff_{source}_to_{target}.json
└── deformation_{source}_to_{target}.npz
```

### Unity プロジェクト

```
Assets/OutfitRetargetingSystem/Editor/
├── config_*.json
├── posediff_*.json
├── deformation_*.npz
├── avatar_data_*.json
└── init_pose.json
```

### リターゲット出力

```
{--output で指定したパス}/
├── {output_base}.fbx
├── {output_base}.blend
└── {output_base}_error_XXX.blend (エラー時のみ)
```

## 関連ドキュメント

- [座標系とデータ変換](coordinate_systems.md)
- [Blender アドオン - データフォーマット](../blender-addon/data_formats.md)
- [Unity アドオン - 処理フロー概要](../unity-addon/overview.md)
- [Unity アドオン - config JSON 仕様](../unity-addon/config_format.md)
